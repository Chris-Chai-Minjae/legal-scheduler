<%# @TASK P2-S2-T1 - Blog post writing main view %>
<%# @SPEC Blog AI Dashboard - 2-column layout with prompt form + document upload %>

<% content_for :title, "ìƒˆ ê¸€ ì‘ì„± - Blog AI" %>

<!-- Blog Header -->
<div class="blog-header">
  <h1>âœï¸ ìƒˆ ê¸€ ì‘ì„±</h1>
  <div class="blog-header-actions">
    <%= link_to "â† ëª©ë¡ìœ¼ë¡œ", blog_posts_path, class: "btn btn-secondary" %>
  </div>
</div>

<!-- Two Column Layout -->
<div style="display: grid; grid-template-columns: 70% 30%; gap: 24px; align-items: start;">

  <!-- Left Column: Prompt Form -->
  <div>
    <div class="blog-prompt-form">
      <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 20px; color: var(--gray-900);">
        ğŸ“ ê¸€ ì‘ì„± ì„¤ì •
      </h2>

      <%= form_with model: @post, url: blog_posts_path, id: "post_form", data: { turbo: false } do |f| %>
        <!-- Prompt -->
        <div class="form-group" style="margin-bottom: 24px;">
          <label class="label" style="display: block; font-weight: 500; margin-bottom: 8px; color: var(--gray-700);">
            ê¸€ ì£¼ì œ <span style="color: var(--danger);">*</span>
          </label>
          <%= f.text_area :prompt,
              class: "blog-prompt-textarea",
              placeholder: "ì–´ë–¤ ì£¼ì œë¡œ ê¸€ì„ ì‘ì„±í• ê¹Œìš”?\nì˜ˆ: ë³€í˜¸ì‚¬ì˜ AI í™œìš©ë²•ì— ëŒ€í•´ ì‘ì„±í•´ì£¼ì„¸ìš”",
              rows: 4,
              required: true,
              style: "margin-bottom: 8px;" %>
          <div style="font-size: 12px; color: var(--gray-500);">
            ğŸ’¡ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í• ìˆ˜ë¡ ë” ì¢‹ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>

        <!-- Tone Selector -->
        <div class="form-group" style="margin-bottom: 24px;">
          <label class="label" style="display: block; font-weight: 500; margin-bottom: 12px; color: var(--gray-700);">
            ê¸€ í†¤
          </label>
          <div class="blog-tone-selector">
            <div class="blog-tone-option">
              <%= f.radio_button :tone, "professional", checked: true, id: "tone_professional" %>
              <%= label_tag "tone_professional", "ğŸ¯ ì „ë¬¸ì ", class: "blog-tone-label" %>
            </div>
            <div class="blog-tone-option">
              <%= f.radio_button :tone, "easy", id: "tone_easy" %>
              <%= label_tag "tone_easy", "ğŸ˜Š ì‰¬ìš´", class: "blog-tone-label" %>
            </div>
            <div class="blog-tone-option">
              <%= f.radio_button :tone, "storytelling", id: "tone_storytelling" %>
              <%= label_tag "tone_storytelling", "ğŸ“– ìŠ¤í† ë¦¬í…”ë§", class: "blog-tone-label" %>
            </div>
          </div>
        </div>

        <!-- Length Selector -->
        <div class="form-group" style="margin-bottom: 24px;">
          <label class="label" style="display: block; font-weight: 500; margin-bottom: 12px; color: var(--gray-700);">
            ê¸€ ê¸¸ì´
          </label>
          <div class="blog-length-selector">
            <div class="blog-length-option">
              <%= f.radio_button :length_setting, "short", id: "length_short" %>
              <%= label_tag "length_short", "ì§§ì€ (1,000ì)", class: "blog-length-label" %>
            </div>
            <div class="blog-length-option">
              <%= f.radio_button :length_setting, "medium", checked: true, id: "length_medium" %>
              <%= label_tag "length_medium", "ë³´í†µ (2,000ì)", class: "blog-length-label" %>
            </div>
            <div class="blog-length-option">
              <%= f.radio_button :length_setting, "long", id: "length_long" %>
              <%= label_tag "length_long", "ê¸´ (4,000ì)", class: "blog-length-label" %>
            </div>
          </div>
        </div>

        <!-- Title (Optional) -->
        <div class="form-group" style="margin-bottom: 24px;">
          <label class="label" style="display: block; font-weight: 500; margin-bottom: 8px; color: var(--gray-700);">
            ì œëª© (ì„ íƒì‚¬í•­)
          </label>
          <%= f.text_field :title,
              class: "input",
              placeholder: "ì œëª©ì„ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ë¹„ì›Œë‘ë©´ AIê°€ ìƒì„±í•©ë‹ˆë‹¤" %>
          <div style="font-size: 12px; color: var(--gray-500); margin-top: 4px;">
            â„¹ï¸ ë¹„ì›Œë‘ë©´ AIê°€ ìë™ìœ¼ë¡œ ì œëª©ì„ ìƒì„±í•©ë‹ˆë‹¤.
          </div>
        </div>

        <!-- Submit Button -->
        <%= button_tag type: "submit", class: "btn btn-primary", style: "width: 100%;" do %>
          âœ¨ AIë¡œ ì‘ì„±í•˜ê¸°
        <% end %>
      <% end %>
    </div>

    <!-- Streaming Output Area (Initially Hidden) -->
    <div id="streaming-output" style="display: none; margin-top: 24px;"
         data-controller="streaming"
         data-streaming-url-value="">
      <div class="blog-editor">
        <h2 data-streaming-target="title"
            class="blog-editor-title"
            contenteditable="true"
            style="margin-bottom: 24px;"></h2>
        <div data-streaming-target="output"
             class="blog-editor-content"
             style="white-space: pre-wrap;"></div>
        <span data-streaming-target="cursor"
              class="streaming-cursor"
              style="display: none;"></span>
      </div>

      <div class="blog-header-actions" style="margin-top: 24px; justify-content: flex-start;">
        <%= button_tag "ğŸ“‹ ë³µì‚¬",
            type: "button",
            class: "btn btn-secondary",
            data: { action: "click->streaming#copy" } %>
        <%= button_tag "ğŸ”„ ì¬ìƒì„±",
            type: "button",
            class: "btn btn-secondary",
            data: { action: "click->streaming#regenerate" } %>
        <%= link_to "ğŸ’¾ ì €ì¥ ì™„ë£Œ",
            "#",
            class: "btn btn-primary",
            data: { streaming_target: "saveLink" },
            style: "margin-left: auto;" %>
      </div>
    </div>
  </div>

  <!-- Right Column: Reference Documents Upload -->
  <div>
    <div class="blog-prompt-form" data-controller="file-upload">
      <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--gray-900);">
        ğŸ“„ ì°¸ê³  ë¬¸ì„œ
      </h3>

      <%= form_with url: blog_documents_path,
          method: :post,
          data: { file_upload_target: "form" },
          multipart: true do |f| %>

        <!-- Dropzone -->
        <div class="file-dropzone"
             data-file-upload-target="dropzone"
             data-action="dragover->file-upload#dragover dragleave->file-upload#dragleave drop->file-upload#drop click->file-upload#click">
          <div class="file-dropzone-icon">ğŸ“</div>
          <div class="file-dropzone-text">íŒŒì¼ì„ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”</div>
          <div class="file-dropzone-hint">ë˜ëŠ” í´ë¦­í•˜ì—¬ ì„ íƒ</div>
          <div class="file-dropzone-hint" style="margin-top: 8px;">
            PDF, DOCX, HWP (ìµœëŒ€ 50MB)
          </div>
        </div>

        <!-- Hidden File Input -->
        <%= f.file_field :file,
            accept: ".pdf,.docx,.hwp",
            data: {
              file_upload_target: "input",
              action: "change->file-upload#select"
            },
            style: "display: none;" %>

        <!-- Tag Selector -->
        <div style="margin-top: 16px;">
          <label class="label" style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: var(--gray-700);">
            íƒœê·¸
          </label>
          <%= f.select :tag,
              options_for_select([
                ["íƒœê·¸ ì—†ìŒ", ""],
                ["íŒë¡€", "íŒë¡€"],
                ["ë²•ë ¹", "ë²•ë ¹"],
                ["ë…¼ë¬¸", "ë…¼ë¬¸"],
                ["ê¸°íƒ€", "ê¸°íƒ€"]
              ]),
              {},
              class: "select" %>
        </div>

        <!-- File Preview Area -->
        <div class="file-preview" data-file-upload-target="preview"></div>

        <!-- Info Box -->
        <div class="info-box" style="margin-top: 16px;">
          <div class="info-icon">ğŸ’¡</div>
          <div class="info-text">
            ì—…ë¡œë“œí•œ ë¬¸ì„œëŠ” AIê°€ ì°¸ê³ í•˜ì—¬ ë” ì „ë¬¸ì ì¸ ë‚´ìš©ì„ ì‘ì„±í•©ë‹ˆë‹¤.
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Form submission handler
  document.getElementById('post_form').addEventListener('submit', async (e) => {
    e.preventDefault()

    const form = e.target
    const formData = new FormData(form)
    const submitButton = form.querySelector('button[type="submit"]')

    // Disable submit button
    submitButton.disabled = true
    submitButton.innerHTML = 'â³ ìƒì„± ì¤‘...'

    try {
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      })

      if (response.ok) {
        const data = await response.json()

        // Show streaming output area
        const outputArea = document.getElementById('streaming-output')
        outputArea.style.display = 'block'

        // Scroll to output
        outputArea.scrollIntoView({ behavior: 'smooth', block: 'start' })

        // Set title (if generated)
        const titleElement = outputArea.querySelector('[data-streaming-target="title"]')
        titleElement.textContent = data.title || formData.get('blog_post[title]') || 'AI ìƒì„± ì œëª©'

        // Set content
        const contentElement = outputArea.querySelector('[data-streaming-target="output"]')
        contentElement.textContent = data.content || 'ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...'

        // Update save link
        const saveLink = outputArea.querySelector('[data-streaming-target="saveLink"]')
        if (data.id) {
          saveLink.href = `/blog/posts/${data.id}`
        }

        // Show success message
        alert('âœ… ê¸€ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!')
      } else {
        throw new Error('ìƒì„± ì‹¤íŒ¨')
      }
    } catch (error) {
      console.error('Error:', error)
      alert('âŒ ê¸€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.')
    } finally {
      // Re-enable submit button
      submitButton.disabled = false
      submitButton.innerHTML = 'âœ¨ AIë¡œ ì‘ì„±í•˜ê¸°'
    }
  })
</script>

<style>
  /* Form Group */
  .form-group {
    margin-bottom: 24px;
  }

  .label {
    display: block;
    font-weight: 500;
    margin-bottom: 8px;
    color: var(--gray-700);
    font-size: 14px;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    /* Stack columns on smaller screens */
    [style*="grid-template-columns: 70% 30%"] {
      grid-template-columns: 1fr !important;
    }
  }
</style>
