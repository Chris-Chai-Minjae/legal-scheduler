<%# @TASK T2.2 - Onboarding Step 3: Calendar selection %>
<%# @SPEC REQ-CAL-02: Designate lbox/work/personal calendars %>

<div class="space-y-6">
  <div>
    <h2 class="text-2xl font-bold text-gray-900 mb-2">캘린더 선택</h2>
    <p class="text-gray-600">
      Google 캘린더 중에서 변론 일정을 읽어올 캘린더(LBOX)와 서면 작성 일정을 저장할 캘린더(업무)를 선택해주세요.
    </p>
  </div>

  <%= turbo_frame_tag "calendar-selector" do %>
    <%
      # Fetch calendars from Google API
      begin
        service = GoogleCalendarService.new(Current.user)
        all_calendars = service.list_calendars
      rescue => e
        all_calendars = []
      end

      # Get current assignments from database
      lbox_calendar = Current.user.calendars.find_by(calendar_type: :lbox)
      work_calendar = Current.user.calendars.find_by(calendar_type: :work)
      personal_calendar = Current.user.calendars.find_by(calendar_type: :personal)
    %>

    <div class="space-y-6">
      <%# LBOX Calendar (Source) - Purple %>
      <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
        <div class="flex items-center gap-2 mb-4">
          <div class="w-4 h-4 rounded-full" style="background-color: #8B5CF6;"></div>
          <h3 class="text-lg font-semibold text-gray-900">LBOX 캘린더 (변론 일정 원본)</h3>
          <span class="text-sm text-red-600 font-medium">필수</span>
        </div>
        <p class="text-sm text-gray-600 mb-4">
          변론 일정이 기록된 캘린더를 선택하세요. 이 캘린더의 일정을 읽어와서 서면 작성 일정을 자동으로 생성합니다.
        </p>

        <%= form_with url: calendar_path(lbox_calendar&.google_id || "temp"), method: :patch, data: { turbo_frame: "calendar-selector" } do |f| %>
          <%= f.hidden_field :calendar_type, value: "lbox" %>

          <div class="space-y-2">
            <%= f.select :id,
              options_for_select(
                all_calendars.map { |cal| [cal[:summary], cal[:id], { "data-color" => cal[:background_color], "data-name" => cal[:summary] }] },
                lbox_calendar&.google_id
              ),
              { prompt: "캘린더를 선택하세요" },
              class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500",
              onchange: "this.form.requestSubmit()"
            %>

            <% if lbox_calendar %>
              <p class="text-sm text-green-600 flex items-center gap-1">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                선택됨: <%= lbox_calendar.name %>
              </p>
            <% end %>
          </div>
        <% end %>
      </div>

      <%# Work Calendar (Target) - Blue %>
      <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
        <div class="flex items-center gap-2 mb-4">
          <div class="w-4 h-4 rounded-full" style="background-color: #2563EB;"></div>
          <h3 class="text-lg font-semibold text-gray-900">업무 캘린더 (서면 작성 일정 저장)</h3>
          <span class="text-sm text-red-600 font-medium">필수</span>
        </div>
        <p class="text-sm text-gray-600 mb-4">
          자동으로 생성된 서면 작성 일정을 저장할 캘린더를 선택하세요.
        </p>

        <%= form_with url: calendar_path(work_calendar&.google_id || "temp"), method: :patch, data: { turbo_frame: "calendar-selector" } do |f| %>
          <%= f.hidden_field :calendar_type, value: "work" %>

          <div class="space-y-2">
            <%= f.select :id,
              options_for_select(
                all_calendars.map { |cal| [cal[:summary], cal[:id], { "data-color" => cal[:background_color], "data-name" => cal[:summary] }] },
                work_calendar&.google_id
              ),
              { prompt: "캘린더를 선택하세요" },
              class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
              onchange: "this.form.requestSubmit()"
            %>

            <% if work_calendar %>
              <p class="text-sm text-green-600 flex items-center gap-1">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                선택됨: <%= work_calendar.name %>
              </p>
            <% end %>
          </div>
        <% end %>
      </div>

      <%# Personal Calendar (Optional) - Green %>
      <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
        <div class="flex items-center gap-2 mb-4">
          <div class="w-4 h-4 rounded-full" style="background-color: #10B981;"></div>
          <h3 class="text-lg font-semibold text-gray-900">개인 캘린더</h3>
          <span class="text-sm text-gray-500 font-medium">선택사항</span>
        </div>
        <p class="text-sm text-gray-600 mb-4">
          개인 일정을 관리할 캘린더를 선택하세요. (추후 기능 확장에 사용될 수 있습니다)
        </p>

        <%= form_with url: calendar_path(personal_calendar&.google_id || "temp"), method: :patch, data: { turbo_frame: "calendar-selector" } do |f| %>
          <%= f.hidden_field :calendar_type, value: "personal" %>

          <div class="space-y-2">
            <%= f.select :id,
              options_for_select(
                all_calendars.map { |cal| [cal[:summary], cal[:id], { "data-color" => cal[:background_color], "data-name" => cal[:summary] }] },
                personal_calendar&.google_id
              ),
              { include_blank: "선택 안 함", prompt: false },
              class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500",
              onchange: "this.form.requestSubmit()"
            %>

            <% if personal_calendar %>
              <p class="text-sm text-green-600 flex items-center gap-1">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                선택됨: <%= personal_calendar.name %>
              </p>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <%# Validation message %>
    <% if all_calendars.empty? %>
      <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-yellow-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          <div>
            <h4 class="text-sm font-medium text-yellow-800">캘린더를 불러올 수 없습니다</h4>
            <p class="text-sm text-yellow-700 mt-1">
              Google 계정 연동을 먼저 완료해주세요.
            </p>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

  <%# Navigation buttons %>
  <div class="flex justify-between pt-6 border-t border-gray-200">
    <button type="button" class="text-gray-600 hover:text-gray-900 font-medium">
      ← 이전
    </button>

    <% if lbox_calendar && work_calendar %>
      <button type="button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">
        다음 단계 →
      </button>
    <% else %>
      <button type="button" disabled class="px-6 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed font-medium">
        다음 단계 → (필수 항목 선택)
      </button>
    <% end %>
  </div>
</div>
